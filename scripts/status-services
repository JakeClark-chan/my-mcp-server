#!/bin/bash

# PentestAgent Service Status Script
# This script checks the status of PostgreSQL and Metasploit RPC server

PROJECT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

echo "ğŸ” Checking service status..."
echo "================================"

# Check PostgreSQL
echo "ğŸ“Š PostgreSQL Status:"
if pgrep -f "postgres.*pentest-postgresql" > /dev/null; then
    PG_PID=$(pgrep -f "postgres.*pentest-postgresql")
    echo "  âœ… Running (PID: $PG_PID)"
    if [ -L "$PROJECT_DIR/.postgresql-data" ]; then
        echo "  ğŸ“‚ Data directory: $(readlink $PROJECT_DIR/.postgresql-data)"
    fi
    echo "  ğŸ”Œ Port: 5433"
    echo "  ğŸ”Œ Socket: /tmp/.s.PGSQL.5433"
else
    echo "  âŒ Not running"
fi

echo ""

# Check Metasploit RPC
echo "ğŸ¯ Metasploit RPC Status:"
if lsof -ti:55553 > /dev/null 2>&1; then
    PORT_PID=$(lsof -ti:55553)
    # Check if it's actually msfrpcd
    if pgrep -f "ruby.*msfrpcd" > /dev/null || ps -p "$PORT_PID" -o comm= 2>/dev/null | grep -q ruby; then
        echo "  âœ… Running (PID: $PORT_PID)"
        echo "  ğŸ”Œ Port: 55553"
        echo "  ğŸ‘¤ Username: msf"
        echo "  ğŸ”‘ Password: 1"
        echo "  ğŸŒ Address: 127.0.0.1"
    else
        echo "  âš ï¸  Port 55553 in use by non-Metasploit process (PID: $PORT_PID)"
    fi
else
    echo "  âŒ Not running"
fi

echo ""

# Check if logs exist
echo "ğŸ“‹ Log Files:"
if [ -f "$PROJECT_DIR/.logs/msfrpcd.log" ]; then
    echo "  ğŸ“„ Metasploit RPC log: $PROJECT_DIR/.logs/msfrpcd.log"
    echo "  ğŸ“ Size: $(du -h "$PROJECT_DIR/.logs/msfrpcd.log" | cut -f1)"
else
    echo "  âŒ No Metasploit RPC log found"
fi

if [ -f "$PROJECT_DIR/.logs/postgresql.log" ]; then
    echo "  ğŸ“„ PostgreSQL log: $PROJECT_DIR/.logs/postgresql.log"
    echo "  ğŸ“ Size: $(du -h "$PROJECT_DIR/.logs/postgresql.log" | cut -f1)"
else
    echo "  âŒ No PostgreSQL log found"
fi

echo ""
echo "ğŸ’¡ Commands available:"
echo "  start-services  - Start all services"
echo "  stop-services   - Stop all services"
echo "  status-services - Show this status (current command)"